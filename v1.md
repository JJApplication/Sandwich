# Sandwich Gzip缓存优化 v1.0

## 优化概述

本次优化主要针对Sandwich项目中的静态页面gzip压缩机制进行了性能提升，通过预压缩缓存避免重复的gzip压缩操作。

## 问题背景

原有实现中，每次浏览器请求支持gzip的静态页面（ForbiddenPage、UnavailablePage）时，都会实时进行gzip压缩，造成不必要的CPU开销。由于这些页面内容是通过embed嵌入的固定内容，完全可以在程序启动时预先压缩并缓存。

## 优化方案

### 1. 新增gzip缓存变量

在`cache.go`中添加了专门的gzip缓存变量：

```go
// gzip压缩后的静态页面缓存
var (
    ForbiddenPageGzip   []byte
    UnavailablePageGzip []byte
)
```

### 2. 实现预压缩机制

#### initGzipCache函数

```go
// 初始化gzip缓存
func initGzipCache() {
    var err error
    ForbiddenPageGzip, err = compressData(ForbiddenPage)
    if err != nil {
        log.Printf("compress ForbiddenPage error: %s\n", err.Error())
    }
    UnavailablePageGzip, err = compressData(UnavailablePage)
    if err != nil {
        log.Printf("compress UnavailablePage error: %s\n", err.Error())
    }
    log.Println("gzip cache initialized")
}
```

#### compressData函数

```go
// 压缩数据到字节数组
func compressData(data []byte) ([]byte, error) {
    var buf bytes.Buffer
    gzw := gzip.NewWriter(&buf)
    _, err := gzw.Write(data)
    if err != nil {
        return nil, err
    }
    err = gzw.Close()
    if err != nil {
        return nil, err
    }
    return buf.Bytes(), nil
}
```

### 3. 优化writeResponse函数

修改了`writeResponse`函数，优先使用预压缩的缓存：

```go
func writeResponse(w http.ResponseWriter, request *http.Request, data []byte) {
    if useGzip(request) {
        // 检查是否有预压缩的缓存
        if gzipData := getGzipCache(data); gzipData != nil {
            w.Header().Set("Content-Encoding", "gzip")
            w.Write(gzipData)
        } else {
            minify(w, data)
        }
    } else {
        w.Write(data)
    }
}
```

#### getGzipCache函数

```go
// 获取对应的gzip缓存数据
func getGzipCache(data []byte) []byte {
    // 通过比较字节数组来确定是哪个页面
    if bytes.Equal(data, ForbiddenPage) {
        return ForbiddenPageGzip
    }
    if bytes.Equal(data, UnavailablePage) {
        return UnavailablePageGzip
    }
    return nil
}
```

### 4. 集成到启动流程

在`sandwich.go`的main函数中添加了初始化调用：

```go
func main() {
    InitConfigFromEnvs()
    InitLog()
    InitMongo()
    InitInflux()
    InitPool()
    // load noengine map
    InitNoEngineDomainMap()
    // load helios config
    InitHeliosConfig()

    // init gzip cache for static pages
    initGzipCache()

    // start sync jobs
    InitSyncJobs()

    // init worker
    InitBreaker()
    InitLimiter()
    // ...
}
```

## 性能提升

1. **CPU使用率降低**：避免了每次请求时的重复gzip压缩操作
2. **响应时间减少**：直接返回预压缩的数据，减少了处理延迟
3. **内存使用优化**：预压缩的数据在程序启动时一次性生成，后续无需额外内存分配

## 技术细节

- 使用`bytes.Equal`进行页面内容匹配，确保准确识别需要缓存的页面
- 保持了原有的`minify`函数作为fallback，确保其他动态内容仍能正常压缩
- 添加了完整的错误处理和日志记录
- 代码通过编译测试，确保兼容性

## 文件修改清单

- `cache.go`: 新增gzip缓存变量和相关函数
- `sandwich.go`: 在main函数中添加缓存初始化调用

## 版本信息

- 优化版本: v1.0
- 优化日期: 2024年
- 影响范围: 静态页面gzip压缩性能
- 兼容性: 完全向后兼容